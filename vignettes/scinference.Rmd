---
title: "Inference for synthetic control methods: the scinference package"
author: "Victor Chernozhukov, Kaspar Wuthrich, Yinchu Zhu"
output: rmarkdown::html_vignette
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Inference for synthetic control methods: the scinference package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction and overview

The package scinference implements the inference methods for synthetic controls and related methods proposed in "An Exact and Robust Conformal Inference Method for Counterfactual and Synthetic Controls" written by V. Chernozhukov, K. Wuthrich, and Y. Zhu (2020). The paper is available here: https://arxiv.org/abs/1712.09089. 

The package can be used to make inferences in settings with one treated unit and $J\ge 1$ control units, where the treated unit is untreated for the first $T_0$ time periods and treated for the remaining $T_1$ periods.

By default, the package computes p-values for the null hypothesis that $H_0:(\theta_{T_0+1},\dots,\theta_{T_0+T_1})=(\theta^0_{T_0+1},\dots,\theta^0_{T_0+T_1})$, where $(\theta_{T_0+1},\dots,\theta_{T_0+T_1})$ is the vector of treatment effects in the post-treatment period. The p-values can be computed using moving block and iid permutations. If \texttt{ci=TRUE}, the package also computes pointwise $(1-\alpha)$ confidence intervals for $\theta_t$ for all $T_0+1\le t \le T_0+T_1$.

The package implements three different estimators of the counterfactuals: difference-in-differences, canonical synthetic control, constrained Lasso. Note that the implementation of synthetic control uses only pre-treatment outcomes as predictors and does not accommodate for additional covariates.

# A simple example

You can download the package via github.
```{r install}
library(scinference)
```
After installing the package, we recommend reading the help file for the command.
```{r help}
?scinference
```
To illustrate the methods, we simulate some data. We consider a setup with $J=50$, $T_0=50$, and $T_1=5$. The control data as generated as iid normal; the outcome equals a weighted average of the contemporaneous control outcomes with sparse weights $(1/3,1/3,1/3,0,\dots,0)$. The treatment effect is constant and equal to $2$ for all periods.
```{r setup}
set.seed(12345)

J   <- 50
T0  <- 50 
T1  <- 5

w       <- rep(0,J)
w[1:3]  <- 1/3
Y0      <- matrix(rnorm((T0+T1)*J),(T0+T1),J)
Y1      <- Y0 %*% w + rnorm(T0+T1)

Y1[(T0+1):(T0+T1)] <- Y1[(T0+1):(T0+T1)] + 2
```
We start by testing the null hypothesis $H_0:\theta=(4,4,4,4,4)'$. We compare the results for all three estimation methods and for moving block and the iid permutations. Per default, the p-value for iid permutations is computed based on 5000 randomly-drawn permutations.
```{r null}
scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="sc",permutation_method="mb")$p_val
scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="did",permutation_method="mb")$p_val
scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="classo",permutation_method="mb")$p_val

scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="did",permutation_method="iid")$p_val
scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="sc",permutation_method="iid")$p_val
scinference(Y1,Y0,T1=T1,T0=T0,theta0=4,estimation_method="classo",permutation_method="iid")$p_val
```
Next, we compute pointwise confidence intervals using the synthetic control method. This requires specifying a grid (see Algorithm 1 in the paper).
```{r ci}

obj <- scinference(Y1,Y0,T1=T1,T0=T0,estimation_method="sc",ci=TRUE,ci_grid=seq(-2,8,0.1))

plot(1, ylab="", xlab="Time", main="90% pointwise CIs",xlim = c(1,5), ylim=c(-1,7), type="n")
lines(1:5, obj$lb, lwd = 2)
lines(1:5, obj$ub, lwd = 2)
abline(h=0,col="darkgrey", lwd=1)
  
```

